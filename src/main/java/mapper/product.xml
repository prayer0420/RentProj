<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.product">

   <select id="test" resultType="int">
      SELECT 1
   </select>

   <!-- 판매 상품 등록 -->
   <insert id="insertProductSell" parameterType="product"
      useGeneratedKeys="true" keyProperty="no">
      INSERT INTO product (no, categoryNo, title, content, state, img1,img2,img3,img4,img5,
      deliveryAddr,deliveryPrice, tradeType, memberNo, salePrice, deliveryStatus,latitude,longitude)
      VALUES (#{no}, #{categoryNo}, #{title}, #{content}, #{state}, #{img1},#{img2},#{img3},#{img4},#{img5},
      #{deliveryAddr},#{deliveryPrice}, #{tradeType}, #{memberNo}, #{salePrice}, #{deliveryStatus}, #{latitude}, #{longitude})
   </insert>

   <!-- 대여 상품 등록 -->
   <insert id="insertProductRent" parameterType="product"
      useGeneratedKeys="true" keyProperty="no">
      INSERT INTO product (no, categoryNo, title, content, state, img1,img2,img3,img4,img5,
      deliveryAddr, deliveryPrice, tradeType, secPrice, memberNo, startDate, endDate,
      rentPrice, deliveryStatus, latitude,longitude)
      VALUES (#{no}, #{categoryNo}, #{title}, #{content}, #{state}, #{img1},#{img2},#{img3},#{img4},#{img5},
      #{deliveryAddr}, #{deliveryPrice}, #{tradeType}, #{secPrice}, #{memberNo}, #{startDate}, #{endDate},
      #{rentPrice}, #{deliveryStatus}, #{latitude}, #{longitude})
   </insert>
   
   <!-- 판매+대여 상품 등록 -->
   <insert id="insertProductRentSell" parameterType="product"
      useGeneratedKeys="true" keyProperty="no">
      INSERT INTO product (no, categoryNo, title, content, state, img1,img2,img3,img4,img5,
      deliveryAddr,deliveryPrice, tradeType, secPrice, memberNo, salePrice, startDate, endDate,
      rentPrice, deliveryStatus,latitude,longitude)
      VALUES (#{no}, #{categoryNo}, #{title}, #{content}, #{state}, #{img1},#{img2},#{img3},#{img4},#{img5},
      #{deliveryAddr},#{deliveryPrice}, #{tradeType}, #{secPrice}, #{memberNo}, #{salePrice}, #{startDate},
      #{endDate}, #{rentPrice}, #{deliveryStatus},#{latitude}, #{longitude})
   </insert>

   <!-- 나눔 상품 등록 -->
   <insert id="insertProductFree" parameterType="product"
      useGeneratedKeys="true" keyProperty="no">
      INSERT INTO product (no, categoryNo, title, content, img1,img2,img3,img4,img5, deliveryAddr,
      tradeType, memberNo,latitude,longitude)
      VALUES (#{no}, #{categoryNo}, #{title}, #{content}, #{img1},#{img2},#{img3},#{img4},#{img5}, #{deliveryAddr},
      #{tradeType}, #{memberNo}, #{latitude}, #{longitude})
   </insert>
   
   <!-- product상세 검색 -->
   <select id="selectProductOne" parameterType="Integer" resultType="product">
      select p.*,m.nickname from product p join member m on (p.memberNo=m.no) where p.no=#{no}
   </select>
   
   <!-- 상품 조회 카드 resultMap -->
   <resultMap id="productMap" type="dto.Product">
      <id property="no" column="no" />
      <result property="title" column="title" />
      <result property="img1" column="img1" />
      <result property="salePrice" column="salePrice" />
      <result property="rentPrice" column="rentPrice" />
      <result property="secPrice" column="secPrice" />
      <result property="tradeType" column="tradeType" />
      <result property="createDate" column="createDate" />
      <result property="latitude" column="latitude" />
      <result property="longitude" column="longitude" />
      <result property="deliveryAddr" column="deliveryAddr" />
   </resultMap>

   <!-- 메인 AJAX용 상품 조회: 검색 + 카테고리 + 필터 + 정렬 -->
   <select id="selectProducts" resultMap="productMap" parameterType="map">
      SELECT no, title, img1, salePrice, rentPrice, secPrice, tradeType, createDate,
             latitude, longitude, deliveryAddr
      FROM product
      <where>
         <if test="searchText != null and searchText != ''">
            AND title LIKE CONCAT('%', #{searchText}, '%')
         </if>
         <if test="categoryNo != null">
            AND categoryNo = #{categoryNo}
         </if>
         <if test="tradeType != null">
            AND tradeType = #{tradeType}
         </if>
      </where>
      <choose>
        <when test="sort == 'priceAsc'">
          ORDER BY COALESCE(salePrice, rentPrice) ASC
        </when>
        <when test="sort == 'priceDesc'">
          ORDER BY COALESCE(salePrice, rentPrice) DESC
        </when>
        <otherwise>
          ORDER BY createDate DESC
        </otherwise>
      </choose>
      LIMIT #{offset}, #{limit}
   </select>


   <!-- 총 상품 수 (검색/필터 기준 없음) -->
   <select id="countAll" parameterType="map" resultType="int">
      SELECT COUNT(*) FROM product
      <where>
         <if test="tradeType != null">
            tradeType = #{tradeType}
         </if>
      </where>
   </select>

   <!-- 검색어 포함 상품 수 -->
	<select id="countByName" parameterType="map" resultType="int">
	  SELECT COUNT(*) FROM product
	  WHERE title LIKE CONCAT('%', #{searchText}, '%')
	  <if test="tradeType != null">
	    AND tradeType = #{tradeType}
	  </if>
	</select>


   <!-- 카테고리별 상품 수 -->
   <select id="countByCategory" parameterType="map"
      resultType="int">
      SELECT COUNT(*) FROM product
      WHERE categoryNo = #{categoryNo}
      <if test="tradeType != null">
         AND tradeType = #{tradeType}
      </if>
   </select>

   <!-- 메인에서 인기 상품 (조회수 기준 정렬) -->
   <select id="selectPopularProducts" resultMap="productMap"
      parameterType="int">
      SELECT no, title, img1, salePrice, rentPrice, tradeType, deliveryAddr
      FROM product
      ORDER BY view_cnt DESC
      LIMIT #{limit}
   </select>

   <!-- 전체 상품 조회 -->
   <select id="selectAll" resultMap="productMap">
        SELECT * FROM product
   </select>
   
   <update id="incrementViewCount" parameterType="int">
   		update product set view_cnt = view_cnt+1 where no=#{no}
   </update>
   <select id="selectViewCount" parameterType="int" resultType="int">
  	 select view_cnt from product where no=#{no}
   </select>
   
</mapper>
