<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="mapper.review">
	<!-- 리뷰쓰기 -->
	<insert id="insertReview" parameterType="Review" useGeneratedKeys="true" keyProperty="no">
		insert into review (no,memberNo,contents,score,productNo,memberNickname) 
		values(#{no},#{memberNo},#{contents},#{score},#{productNo},#{memberNickname})
	</insert>
	
	<!-- 리뷰삭제 -->
	<delete id="deleteReview" parameterType="int">
		delete from review where no=#{no}
	</delete>
	
	<!-- 리뷰수정 -->
	<update id="updateReview" parameterType="int">
		update review set contents=#{contents} where memberNo=#{memberNo}
	</update>


	<select id="selectByProductNo" parameterType="int" resultType="review">
		select * from review where productNo=#{productNo} order by no DESC
	</select>	
	
	<select id="selectAvgScore" parameterType="int" resultType="double">
		select round(avg(score),1)from review where productNo = #{productNo}
	</select>
	
	 <!-- 리뷰 작성 가능한 상품 목록 -->
    <select id="getWritableReviewList" parameterType="int" resultType="order">
        SELECT o.orderNo, o.orderDate, o.productNo, p.title, p.img
        FROM `order` o
        JOIN product p ON o.productNo = p.no
        LEFT JOIN review r ON o.productNo = r.productNo AND o.memberNo = r.memberNo
        WHERE o.memberNo = #{memberNo}
          AND (o.orderStatus = '대여종료' OR o.orderStatus = '거래완료')
          AND r.no IS NULL
        ORDER BY o.orderDate DESC
    </select>

    <!-- 내가 작성한 리뷰 목록 -->
    <select id="getMyReviewList" parameterType="int" resultType="review">
        SELECT r.*, p.title, p.img
        FROM review r
        JOIN product p ON r.productNo = p.no
        WHERE r.memberNo = #{memberNo}
        ORDER BY r.date DESC
    </select>

    <!-- 내 상품에 달린 리뷰 목록 -->
    <select id="getMyProductReviewList" parameterType="int" resultType="review">
        SELECT r.*, p.title, p.img
        FROM review r
        JOIN product p ON r.productNo = p.no
        WHERE p.memberNo = #{memberNo}
        ORDER BY r.date DESC
    </select>
	
	
</mapper>